<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard | Credit Wise</title>
  <link rel="stylesheet" href="css/style.css" />

  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="js/curriculum-master.js"></script>
  <script src="js/user.js"></script>

  <script>
    google.charts.load('current', { packages: ['corechart'] });

    function drawChart(history) {
      if (typeof google === 'undefined' || !google.visualization || !google.visualization.arrayToDataTable) return;

      const chartDataArray = [['Term', 'GPAX', 'GPA']];
      history.forEach(item => chartDataArray.push([item.term, item.gpax, item.term_gpa]));

      const data = google.visualization.arrayToDataTable(chartDataArray);
      const options = {
        legend: { position: 'bottom' },
        curveType: 'function',
        chartArea: { left: 40, top: 10, width: '85%', height: '70%' },
        colors: ['#1557d5', '#7ba8ff'],
        lineWidth: 3,
        backgroundColor: '#ffffff',
        hAxis: { textStyle: { color: '#1b2b57' } },
        vAxis: { minValue: 0, maxValue: 4, ticks: [0, 1, 2, 3, 4], textStyle: { color: '#1b2b57' } }
      };
      new google.visualization.LineChart(document.getElementById('curve_chart')).draw(data, options);
    }

    function updateDashboardInfo() {
      const userData = getCurrentUserData();
      const history = userData.academic_history || [];
      const trackId = userData.info.track_id;
      const trackName = window.TRACKS_INFO?.[trackId]?.full_name || 'N/A';

      document.getElementById('student-badge').textContent =
        `${userData.info.name || 'N/A'} ‚Ä¢ ${userData.info.id || 'N/A'}`;
      document.getElementById('student-track').textContent = `Track: ${trackName}`;

      const latest = history.length ? history.at(-1) : { gpax: 0, term_gpa: 0 };
      document.querySelector('.dash-card.big:nth-child(1) .dash-value').textContent = latest.gpax.toFixed(2);
      document.querySelector('.dash-card.big:nth-child(2) .dash-value').textContent = latest.term_gpa.toFixed(2);

      const gradeList = document.querySelector('.dash-card.grade-list .grades');
      gradeList.innerHTML = history
        .slice()
        .reverse()
        .map(item => `<div><span>${item.term}</span><b>${item.term_gpa.toFixed(2)}</b></div>`)
        .join('');

      google.charts.setOnLoadCallback(() => drawChart(history));
    }

    document.addEventListener('DOMContentLoaded', updateDashboardInfo);
    window.addEventListener('resize', () => {
      const userData = getCurrentUserData?.() || { academic_history: [] };
      drawChart(userData.academic_history);
    });
  </script>
</head>

<body class="bg user-page">
  <div class="layout">
    
    <!-- ===== SIDEBAR ===== -->
    <aside class="sidebar" id="sidebar">
      <div class="side-title">
        <div class="hat"></div>
        <div>Credit Wise üéì</div>
        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î sidebar -->
        <button class="hamburger side-close" id="closeMenu" aria-label="Close menu">‚úï</button>
      </div>

      <a class="side-btn active" href="dashboard.html">Dashboard</a>
      <a class="side-btn" href="curriculum.html">Curriculum Plan</a>
      <a class="side-btn" href="grade-entry.html">Grade Entry</a>
      <a class="side-btn" href="planner.html">Planner</a>
      <a class="side-btn" href="index.html">Sign Out</a>
    </aside>

    <!-- ===== MAIN CONTENT ===== -->
    <main>
      <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î sidebar (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å) -->
      <div class="mobile-topbar">
        <button class="hamburger" id="menuBtn" aria-label="Toggle menu">‚ò∞</button>
      </div>

      <div class="page-head" style="margin-top: 5%;">
        <div class="badge" id="student-badge"></div>
      </div>

      <div class="page-head">
        <h2 style="margin:0;color:#fff;text-shadow:2px 2px 3px #182747;">Dashboard</h2>
        <div id="student-track" style="color:#040431;"></div>
      </div>

      <div class="panel">
        <h3>Welcome to Credit Wise üéì</h3>
        <p>‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏ô‡∏π‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤: <b>Curriculum Plan</b>, <b>Grade Entry</b>, ‡πÅ‡∏•‡∏∞ <b>Planner</b>.</p>
        <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å JavaScript ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô Static ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô AWS.</p>
      </div>

      <div class="dash-grid">
        <div class="dash-card big">
          <div class="dash-title">GPAX</div>
          <div class="dash-value">‚Äî</div>
        </div>
        <div class="dash-card big">
          <div class="dash-title">GPA</div>
          <div class="dash-value">‚Äî</div>
        </div>
        <div class="dash-card wide">
          <div id="curve_chart" style="width:100%;height:300px;"></div>
        </div>
        <div class="dash-card grade-list">
          <div class="dash-title">History</div>
          <div class="grades"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- ===== SCRIPT TOGGLE SIDEBAR ===== -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const sidebar  = document.getElementById('sidebar');
      const openBtn  = document.getElementById('menuBtn');
      const closeBtn = document.getElementById('closeMenu');

      if (openBtn)  openBtn.addEventListener('click',  () => sidebar.classList.add('is-open'));
      if (closeBtn) closeBtn.addEventListener('click', () => sidebar.classList.remove('is-open'));
    });
  </script>
</body>
</html>
